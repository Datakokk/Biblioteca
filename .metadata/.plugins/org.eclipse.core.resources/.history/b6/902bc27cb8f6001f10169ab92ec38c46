package com.biblioteca.gui;

import com.biblioteca.dao.PrestamoDAO;
import com.biblioteca.modelo.Libro;
import com.biblioteca.modelo.Prestamo;
import com.biblioteca.modelo.Usuario;
import com.biblioteca.servicio.LibroServicio;
import com.biblioteca.servicio.PrestamoServicio;
import com.biblioteca.util.ConexionJDBC;

import javax.swing.*;
import java.awt.*;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

public class UsuarioFrame extends JFrame {
    private Usuario usuario;
    private LibroServicio libroServicio;
    private PrestamoServicio prestamoServicio;

    // Constructor que recibe un Usuario autenticado
    public UsuarioFrame(Usuario usuario) {
        this.usuario = usuario;
        setTitle("Panel de Usuario - Biblioteca");
        setSize(600, 400);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        setLayout(new BorderLayout());

        // ConexiÃ³n a la base de datos
        try {
            Connection conexion = ConexionJDBC.obtenerConexion();
            libroServicio = new LibroServicio(conexion);
            prestamoServicio = new PrestamoServicio(new PrestamoDAO(conexion));
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this, "Error al conectar con la base de datos", "Error", JOptionPane.ERROR_MESSAGE);
            System.exit(1);
        }

        // Barra de menÃº
        JMenuBar menuBar = new JMenuBar();

        // MenÃº de libros
        JMenu librosMenu = new JMenu("Libros");
        JMenuItem listarLibros = new JMenuItem("Ver Libros Disponibles");
        JMenuItem prestarLibro = new JMenuItem("Realizar PrÃ©stamo");
        JMenuItem devolverLibro = new JMenuItem("Devolver Libro");
        JMenuItem verPrestamos = new JMenuItem("Ver Mis PrÃ©stamos");

        librosMenu.add(listarLibros);
        librosMenu.add(prestarLibro);
        librosMenu.add(devolverLibro);
        librosMenu.add(verPrestamos);

        // MenÃº de sesiÃ³n
        JMenu sesionMenu = new JMenu("SesiÃ³n");
        JMenuItem cerrarSesion = new JMenuItem("Cerrar SesiÃ³n");
        sesionMenu.add(cerrarSesion);

        // Agregar menÃºs a la barra
        menuBar.add(librosMenu);
        menuBar.add(sesionMenu);
        setJMenuBar(menuBar);

        // AcciÃ³n para cerrar sesiÃ³n
        cerrarSesion.addActionListener(e -> {
            dispose();
            new LoginFrame().setVisible(true);
        });

        // Acciones de los botones
        listarLibros.addActionListener(e -> listarLibros());
        prestarLibro.addActionListener(e -> realizarPrestamo());
        devolverLibro.addActionListener(e -> devolverLibro());
        verPrestamos.addActionListener(e -> verPrestamosActivos());

        // Mensaje de bienvenida
        JLabel bienvenida = new JLabel("Bienvenido, " + usuario.getNombre(), SwingConstants.CENTER);
        add(bienvenida, BorderLayout.CENTER);
    }

    // MÃ©todo para listar libros disponibles
    private void listarLibros() {
        try {
            List<Libro> libros = libroServicio.listarLibros();
            StringBuilder listaLibros = new StringBuilder("ðŸ“š Libros disponibles:\n");
            for (Libro l : libros) {
                if (l.getEstado().equalsIgnoreCase("disponible")) {
                    listaLibros.append(l.getIdLibro()).append(" - ").append(l.getTitulo()).append(" de ").append(l.getAutor()).append("\n");
                }
            }
            JOptionPane.showMessageDialog(this, listaLibros.toString());
        } catch (SQLException ex) {
            JOptionPane.showMessageDialog(this, "Error al listar libros: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    // MÃ©todo para realizar un prÃ©stamo
    private void realizarPrestamo() {
        try {
            String idLibroStr = JOptionPane.showInputDialog(this, "Ingrese el ID del libro a prestar:");
            if (idLibroStr != null) {
                int idLibro = Integer.parseInt(idLibroStr);

                Prestamo prestamo = new Prestamo();
                prestamo.setIdUsuario(usuario.getIdUsuario());
                prestamo.setIdLibro(idLibro);
                prestamo.setFechaPrestamo(new java.util.Date());

                prestamoServicio.registrarPrestamo(prestamo);
                JOptionPane.showMessageDialog(this, "âœ… PrÃ©stamo realizado con Ã©xito.");
            }
        } catch (SQLException ex) {
            JOptionPane.showMessageDialog(this, "Error al registrar el prÃ©stamo: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
        } catch (NumberFormatException ex) {
            JOptionPane.showMessageDialog(this, "ID de libro invÃ¡lido", "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    // MÃ©todo para devolver un libro
    private void devolverLibro() {
        try {
            String idPrestamoStr = JOptionPane.showInputDialog(this, "Ingrese el ID del prÃ©stamo a devolver:");
            if (idPrestamoStr != null) {
                int idPrestamo = Integer.parseInt(idPrestamoStr);

                prestamoServicio.devolverLibro(idPrestamo);
                JOptionPane.showMessageDialog(this, "ðŸ“Œ Libro devuelto con Ã©xito.");
            }
        } catch (SQLException ex) {
            JOptionPane.showMessageDialog(this, "Error al devolver el libro: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
        } catch (NumberFormatException ex) {
            JOptionPane.showMessageDialog(this, "ID de prÃ©stamo invÃ¡lido", "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    // MÃ©todo para ver prÃ©stamos activos
    private void verPrestamosActivos() {
        try {
            List<Prestamo> prestamos = prestamoServicio.obtenerPrestamosActivosPorUsuario(usuario.getIdUsuario());
            StringBuilder listaPrestamos = new StringBuilder("ðŸ“Œ Mis PrÃ©stamos Activos:\n");
            for (Prestamo p : prestamos) {
                listaPrestamos.append("ðŸ“– Libro ID: ").append(p.getIdLibro()).append(" | Fecha PrÃ©stamo: ").append(p.getFechaPrestamo()).append("\n");
            }
            JOptionPane.showMessageDialog(this, listaPrestamos
